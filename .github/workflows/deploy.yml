name: Deploy SEQ1 UI to Vercel

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  deploy:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ›ï¸ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ğŸ“‹ Install dependencies
      run: |
        npm ci
        npm install -g vercel@latest
    
    - name: ğŸ§ª Run pre-deploy validation
      run: |
        echo "ğŸ” Running code quality checks..."
        npm run lint || echo "âš ï¸ Linting warnings detected"
        
        echo "ğŸ§ª Running type checking..."
        npm run type-check || npx tsc --noEmit || echo "âš ï¸ Type checking issues detected"
        
        echo "ğŸ§ª Testing imports and dependencies..."
        node -e "
        try {
          require('./package.json');
          console.log('âœ… Package.json is valid');
        } catch (e) {
          console.error('âŒ Package.json validation failed:', e.message);
          process.exit(1);
        }
        "
        
        echo "ğŸ”§ Validating Next.js configuration..."
        npx next info || echo "âš ï¸ Next.js configuration warnings"
        
        echo "âœ… Pre-deploy validation passed"
    
    - name: ğŸ—ï¸ Build project (with validation)
      run: |
        echo "ğŸ”¨ Building Next.js application..."
        npm run build
        
        echo "ğŸ” Validating build output..."
        if [ ! -d ".next" ]; then
          echo "âŒ Build failed - .next directory not found"
          exit 1
        fi
        
        echo "ğŸ“Š Build size analysis..."
        du -sh .next/ || echo "Build size could not be analyzed"
        
        echo "âœ… Build completed successfully"
    
    - name: ğŸ§ª Test build locally
      run: |
        echo "ğŸ§ª Testing built application..."
        
        # Start the application in background
        npm start &
        APP_PID=$!
        
        # Wait for app to start
        echo "â³ Waiting for application to start..."
        sleep 10
        
        # Test if app is responding
        if curl -f http://localhost:3000 > /dev/null 2>&1; then
          echo "âœ… Local build test passed"
        else
          echo "âš ï¸ Local build test failed, but continuing deployment"
        fi
        
        # Clean up
        kill $APP_PID || true
      continue-on-error: true
    
    - name: ğŸš€ Deploy to Vercel (with retry)
      env:
        VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      run: |
        echo "ğŸš€ Starting deployment to Vercel..."
        
        # First attempt - standard production deploy
        if timeout 300 vercel --token $VERCEL_TOKEN --prod --yes; then
          echo "âœ… Deployment successful on first attempt"
        else
          echo "âš ï¸ First deployment attempt failed, trying with force flag..."
          sleep 10
          
          # Second attempt - force deploy
          if timeout 300 vercel --token $VERCEL_TOKEN --prod --yes --force; then
            echo "âœ… Deployment successful on second attempt"
          else
            echo "âŒ Second deployment attempt failed, trying clean deploy..."
            sleep 20
            
            # Third attempt - clean deploy
            if timeout 600 bash -c "
              vercel --token $VERCEL_TOKEN remove seq1-ui --yes || true &&
              vercel --token $VERCEL_TOKEN --prod --yes
            "; then
              echo "âœ… Deployment successful on third attempt"
            else
              echo "âŒ All deployment attempts failed"
              exit 1
            fi
          fi
        fi
    
    - name: ğŸ” Get deployment URL
      env:
        VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      run: |
        echo "ğŸ” Getting deployment information..."
        
        # Get latest deployment URL
        DEPLOYMENT_URL=$(vercel --token $VERCEL_TOKEN ls --scope $VERCEL_ORG_ID | grep seq1-ui | head -1 | awk '{print $2}')
        
        if [ -n "$DEPLOYMENT_URL" ]; then
          echo "ğŸŒ Deployment URL: https://$DEPLOYMENT_URL"
          echo "DEPLOYMENT_URL=https://$DEPLOYMENT_URL" >> $GITHUB_ENV
        else
          echo "âš ï¸ Could not determine deployment URL"
          echo "DEPLOYMENT_URL=https://seq1-ui.vercel.app" >> $GITHUB_ENV
        fi
    
    - name: âœ… Verify deployment
      env:
        VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      run: |
        echo "ğŸ” Verifying deployment status..."
        
        # Check Vercel deployment status
        vercel --token $VERCEL_TOKEN ls | head -10
        
        echo "âœ… SEQ1 UI deployment verification complete!"
    
    - name: ğŸŒ Test deployed application (with retries)
      run: |
        echo "ğŸ§ª Testing deployed application..."
        
        # Wait for deployment to propagate
        echo "â³ Waiting for deployment to propagate..."
        sleep 30
        
        # Test deployment with retries
        for i in {1..5}; do
          echo "ğŸ” Health check attempt $i/5..."
          if curl -f -s --max-time 10 $DEPLOYMENT_URL > /dev/null; then
            echo "âœ… Deployment health check passed"
            
            # Test if it looks like a React app
            if curl -s --max-time 10 $DEPLOYMENT_URL | grep -q "react\|next\|SEQ1"; then
              echo "âœ… Application content validation passed"
            else
              echo "âš ï¸ Application content validation inconclusive"
            fi
            break
          else
            if [ $i -eq 5 ]; then
              echo "âŒ Health check failed after 5 attempts"
              echo "ğŸ“Š Final deployment status:"
              curl -I $DEPLOYMENT_URL || echo "Could not get headers"
            else
              echo "âš ï¸ Health check failed, retrying in 10 seconds..."
              sleep 10
            fi
          fi
        done
        
        echo "âœ… Deployed application testing complete"
      continue-on-error: true
    
    - name: ğŸ“ˆ Deployment Summary
      run: |
        echo "ğŸ‰ SEQ1 UI deployment completed successfully!"
        echo "ğŸŒ Deployment URL: $DEPLOYMENT_URL"
        echo "âš¡ Platform: Vercel"
        echo "ğŸ”§ Framework: Next.js 18" 